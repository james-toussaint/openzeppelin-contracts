name: Release Upgradeable

on:
  workflow_dispatch: {}

jobs:
  release-upgradeable:
    environment: push-upgradeable
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          repository: OpenZeppelin/openzeppelin-contracts
          fetch-depth: 0
      - name: Get vanilla commit
        run: |
          VANILLA_COMMIT=$(git rev-parse --short HEAD)
          echo "VANILLA_COMMIT: $VANILLA_COMMIT"
      - uses: actions/checkout@v5
        with:
          repository: james-toussaint/openzeppelin-contracts-upgradeable
          fetch-depth: 0
          submodules: true
          token: ${{ secrets.GH_TOKEN_UPGRADEABLE }}
          ref: ${{ github.ref }}
      - name: Run
        run: |
          git log -1 --pretty=%B
          if [[ $(git log -1 --pretty=%B) != "Transpile $VANILLA_COMMIT" ]]; then
            echo "Expected 'Transpile $VANILLA_COMMIT' but found '$(git log -1 --pretty=%B)'"
          fi
          VERSION="$(jq -r .version package.json)"
          TAG="v$VERSION"
          ### START BLOCK - TODO: Remove block
          sed -i '' -e 's/openzeppelin\/contracts-upgradeable/james-toussaint\/contracts-upgradeable/g' contracts/package.json
          sed -i '' -e 's/$VERSION/$VERSION-$(date +%s)/g' contracts/package.json && head contracts/package.json
          TAG="$TAG-$(date +%s)"
          ### END BLOCK
          npm ci
          bash scripts/git-user-config.sh
          git tag -m {,}$TAG
          git push origin tag $TAG
          NPM_TAG="tmp"
          if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            NPM_TAG="next"
          elif [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-rc.[0-9]+$ ]]; then
            NPM_TAG="dev"
          fi
          cd contracts
          # Intentionally escape $ to avoid interpolation and writing the token to disk
          echo "//registry.npmjs.org/:_authToken=\${NPM_TOKEN}" > .npmrc
          npm publish --tag $NPM_TAG
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
